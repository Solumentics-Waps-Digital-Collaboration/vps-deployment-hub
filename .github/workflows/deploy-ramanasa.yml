name: Deploy Ramanasa.com

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Stage 1 - Connection Check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Connected to VPS successfully!"
            echo "Server: $(hostname)"
            echo "User: $(whoami)"
      
      - name: Stage 2 - Prepare Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Preparing deployment environment..."
            cd /var/www/deployment-hub/sites/ramanasa
            chmod +x deploy.sh
            echo "Ready to deploy!"
      
      - name: Stage 3 - Clone & Build
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Cloning repo and building site..."
            cd /var/www/deployment-hub/sites/ramanasa
            ./deploy.sh
      
      - name: Stage 4 - Deploy to Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Website deployed to /var/www/sites/ramanasa"
            echo "Nginx is now serving ramanasa.com"
      
      - name: Stage 5 - Verification
        run: |
          echo "========================================="
          echo "Deployment Complete!"
          echo "Live at: https://ramanasa.com"
          echo "Deployed: $(date)"
          echo "========================================="