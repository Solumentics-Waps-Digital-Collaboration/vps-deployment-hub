name: Deploy WAPS Digital (Payload CMS)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options: [production]
        default: production

env:
  SITE_NAME: waps-digital
  DOMAIN: waps-digital.cloud
  SOURCE_REPO: Solumentics-Waps-Digital-Collaboration/waps-digital
  SOURCE_BRANCH: main
  DEPLOY_PATH: /var/www/sites/waps-digital
  SCRIPTS_PATH: /var/www/deployment-hub/sites/waps-digital

jobs:
  setup:
    name: Stage 1 - Setup and Validation
    runs-on: ubuntu-latest
    outputs:
      commit-sha: ${{ steps.get-commit.outputs.sha }}
      deploy-time: ${{ steps.get-time.outputs.time }}
    steps:
      - name: Get deployment timestamp
        id: get-time
        run: |
          DEPLOY_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "time=$DEPLOY_TIME" >> $GITHUB_OUTPUT
          echo "Deployment started at: $DEPLOY_TIME"

      - name: Fetch latest commit SHA
        id: get-commit
        run: |
          COMMIT_SHA=$(curl -s https://api.github.com/repos/${{ env.SOURCE_REPO }}/commits/${{ env.SOURCE_BRANCH }} | jq -r '.sha' | cut -c1-7)
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "Latest commit SHA: $COMMIT_SHA"

      - name: Validate GitHub secrets
        run: |
          echo "Validating required secrets..."
          [ -n "${{ secrets.VPS_HOST }}" ] || { echo "VPS_HOST missing"; exit 1; }
          [ -n "${{ secrets.VPS_USER }}" ] || { echo "VPS_USER missing"; exit 1; }
          [ -n "${{ secrets.VPS_SSH_KEY }}" ] || { echo "VPS_SSH_KEY missing"; exit 1; }
          [ -n "${{ secrets.VPS_PORT }}" ] || { echo "VPS_PORT missing"; exit 1; }
          echo "All secrets validated"

  connection:
    name: Stage 2 - VPS Connection Check
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Test SSH connection to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "========================================="
            echo "VPS Connection Successful!"
            echo "========================================="
            echo "Hostname: $(hostname)"
            echo "User: $(whoami)"
            echo "Docker: $(docker --version)"
            echo "Docker Compose: $(docker-compose --version)"
            echo "========================================="

      - name: Verify deployment directories exist
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Checking deployment directories..."
            [ -d "${{ env.SCRIPTS_PATH }}" ] || { echo "Scripts directory missing"; exit 1; }
            [ -f "${{ env.SCRIPTS_PATH }}/deploy.sh" ] || { echo "deploy.sh missing"; exit 1; }
            [ -f "${{ env.DEPLOY_PATH }}/.env" ] || { echo ".env file missing - please create it!"; exit 1; }
            echo "All directories and files present"

  prepare:
    name: Stage 3 - Pre-deployment Preparation
    runs-on: ubuntu-latest
    needs: [setup, connection]
    steps:
      - name: Stop existing containers (if running)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Stopping existing containers..."
            if [ -d "${{ env.DEPLOY_PATH }}" ] && [ -f "${{ env.DEPLOY_PATH }}/docker-compose.prod.yml" ]; then
              cd ${{ env.DEPLOY_PATH }}
              docker-compose -f docker-compose.prod.yml down || echo "No containers to stop"
            else
              echo "No existing deployment found"
            fi

      - name: Make deployment script executable
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Setting script permissions..."
            cd ${{ env.SCRIPTS_PATH }}
            chmod +x deploy.sh
            echo "deploy.sh is executable"

  build-and-deploy:
    name: Stage 4 - Build and Deploy Docker Containers
    runs-on: ubuntu-latest
    needs: [setup, connection, prepare]
    steps:
      - name: Execute deployment script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          script: |
            echo "========================================="
            echo "Starting Deployment Process"
            echo "========================================="
            echo "Site: ${{ env.SITE_NAME }}"
            echo "Domain: ${{ env.DOMAIN }}"
            echo "Commit: ${{ needs.setup.outputs.commit-sha }}"
            echo "Time: ${{ needs.setup.outputs.deploy-time }}"
            echo "========================================="
            
            cd ${{ env.SCRIPTS_PATH }}
            ./deploy.sh
            
            EXIT_CODE=$?
            if [ $EXIT_CODE -ne 0 ]; then
              echo "Deployment script failed with exit code $EXIT_CODE"
              exit $EXIT_CODE
            fi
            
            echo "Deployment script completed successfully"

  verify:
    name: Stage 5 - Verification and Health Check
    runs-on: ubuntu-latest
    needs: [setup, connection, prepare, build-and-deploy]
    steps:
      - name: Verify Docker containers are running
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Checking Docker containers..."
            cd ${{ env.DEPLOY_PATH }}
            
            if ! docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
              echo "Containers are not running!"
              docker-compose -f docker-compose.prod.yml logs --tail=50
              exit 1
            fi
            
            echo "Docker containers are running"
            docker-compose -f docker-compose.prod.yml ps

      - name: Check application health
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Checking application health..."
            
            # Wait for app to be ready (max 60 seconds)
            for i in {1..12}; do
              if curl -f http://localhost:3000 > /dev/null 2>&1; then
                echo "Application is responding on port 3000"
                break
              fi
              echo "Waiting for application... ($i/12)"
              sleep 5
            done

      - name: Check Nginx status
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Checking Nginx status..."
            sudo systemctl is-active nginx || { echo "Nginx is not running"; exit 1; }
            sudo nginx -t || { echo "Nginx config has errors"; exit 1; }
            echo "Nginx is running and configured correctly"

      - name: Test website accessibility
        run: |
          echo "Testing website accessibility..."
          sleep 10
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.DOMAIN }} || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Website is accessible (HTTP $HTTP_CODE)"
          elif [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "Website redirecting (HTTP $HTTP_CODE) - checking HTTPS..."
            HTTPS_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.DOMAIN }} || echo "000")
            if [ "$HTTPS_CODE" = "200" ]; then
              echo "Website is accessible via HTTPS (HTTP $HTTPS_CODE)"
            else
              echo "Website not accessible (HTTPS returned $HTTPS_CODE)"
              echo "Note: DNS propagation may take 5-30 minutes"
            fi
          else
            echo "Website not accessible (HTTP $HTTP_CODE)"
            echo "Note: DNS propagation may take 5-30 minutes"
          fi

      - name: Deployment summary
        run: |
          echo "==========================================="
          echo "DEPLOYMENT SUCCESSFUL!"
          echo "==========================================="
          echo "Site: ${{ env.SITE_NAME }}"
          echo "Domain: ${{ env.DOMAIN }}"
          echo "Type: Payload CMS (Docker)"
          echo "Commit: ${{ needs.setup.outputs.commit-sha }}"
          echo "Deployed: ${{ needs.setup.outputs.deploy-time }}"
          echo "==========================================="
          echo "Visit: https://${{ env.DOMAIN }}"
          echo "Admin: https://${{ env.DOMAIN }}/admin"
          echo "==========================================="